<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBA Recipients Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script>
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).dayjs=e()}(this,(function(){"use strict";var t=1e3,e=6e4,n=36e5,r="millisecond",i="second",s="minute",u="hour",a="day",o="week",f="month",h="quarter",c="year",d="date",l="Invalid Date",$=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,y=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,M={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(t){var e=["th","st","nd","rd"],n=t%100;return"["+t+(e[(n-20)%10]||e[n]||e[0])+"]"}},m=function(t,e,n){var r=String(t);return!r||r.length>=e?t:""+Array(e+1-r.length).join(n)+t},v={s:m,z:function(t){var e=-t.utcOffset(),n=Math.abs(e),r=Math.floor(n/60),i=n%60;return(e<=0?"+":"-")+m(r,2,"0")+":"+m(i,2,"0")},m:function t(e,n){if(e.date()<n.date())return-t(n,e);var r=12*(n.year()-e.year())+(n.month()-e.month()),i=e.clone().add(r,f),s=n-i<0,u=e.clone().add(r+(s?-1:1),f);return+(-(r+(n-i)/(s?i-u:u-i))||0)},a:function(t){return t<0?Math.ceil(t)||0:Math.floor(t)},p:function(t){return{M:f,y:c,w:o,d:a,D:d,h:u,m:s,s:i,ms:r,Q:h}[t]||String(t||"").toLowerCase().replace(/s$/,"")},u:function(t){return void 0===t}},g="en",D={};D[g]=M;var p=function(t){return t instanceof _},S=function t(e,n,r){var i;if(!e)return g;if("string"==typeof e){var s=e.toLowerCase();D[s]&&(i=s),n&&(D[s]=n,i=s);var u=e.split("-");if(!i&&u.length>1)return t(u[0])}else{var a=e.name;D[a]=e,i=a}return!r&&i&&(g=i),i||!r&&g},w=function(t,e){if(p(t))return t.clone();var n="object"==typeof e?e:{};return n.date=t,n.args=arguments,new _(n)},O=v;O.l=S,O.i=p,O.w=function(t,e){return w(t,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var _=function(){function M(t){this.$L=S(t.locale,null,!0),this.parse(t)}var m=M.prototype;return m.parse=function(t){this.$d=function(t){var e=t.date,n=t.utc;if(null===e)return new Date(NaN);if(O.u(e))return new Date;if(e instanceof Date)return new Date(e);if("string"==typeof e&&!/Z$/i.test(e)){var r=e.match($);if(r){var i=r[2]-1||0,s=(r[7]||"0").substring(0,3);return n?new Date(Date.UTC(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)):new Date(r[1],i,r[3]||1,r[4]||0,r[5]||0,r[6]||0,s)}}return new Date(e)}(t),this.$x=t.x||{},this.init()},m.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},m.$utils=function(){return O},m.isValid=function(){return!(this.$d.toString()===l)},m.isSame=function(t,e){var n=w(t);return this.startOf(e)<=n&&n<=this.endOf(e)},m.isAfter=function(t,e){return w(t)<this.startOf(e)},m.isBefore=function(t,e){return this.endOf(e)<w(t)},m.$g=function(t,e,n){return O.u(t)?this[e]:this.set(n,t)},m.unix=function(){return Math.floor(this.valueOf()/1e3)},m.valueOf=function(){return this.$d.getTime()},m.startOf=function(t,e){var n=this,r=!!O.u(e)||e,h=O.p(t),l=function(t,e){var i=O.w(n.$u?Date.UTC(n.$y,e,t):new Date(n.$y,e,t),n);return r?i:i.endOf(a)},$=function(t,e){return O.w(n.toDate()[t].apply(n.toDate("s"),(r?[0,0,0,0]:[23,59,59,999]).slice(e)),n)},y=this.$W,M=this.$M,m=this.$D,v="set"+(this.$u?"UTC":"");switch(h){case c:return r?l(1,0):l(31,11);case f:return r?l(1,M):l(0,M+1);case o:var g=this.$locale().weekStart||0,D=(y<g?y+7:y)-g;return l(r?m-D:m+(6-D),M);case a:case d:return $(v+"Hours",0);case u:return $(v+"Minutes",1);case s:return $(v+"Seconds",2);case i:return $(v+"Milliseconds",3);default:return this.clone()}},m.endOf=function(t){return this.startOf(t,!1)},m.$set=function(t,e){var n,o=O.p(t),h="set"+(this.$u?"UTC":""),l=(n={},n[a]=h+"Date",n[d]=h+"Date",n[f]=h+"Month",n[c]=h+"FullYear",n[u]=h+"Hours",n[s]=h+"Minutes",n[i]=h+"Seconds",n[r]=h+"Milliseconds",n)[o],$=o===a?this.$D+(e-this.$W):e;if(o===f||o===c){var y=this.clone().set(d,1);y.$d[l]($),y.init(),this.$d=y.set(d,Math.min(this.$D,y.daysInMonth())).$d}else l&&this.$d[l]($);return this.init(),this},m.set=function(t,e){return this.clone().$set(t,e)},m.get=function(t){return this[O.p(t)]()},m.add=function(r,h){var d,l=this;r=Number(r);var $=O.p(h),y=function(t){var e=w(l);return O.w(e.date(e.date()+Math.round(t*r)),l)};if($===f)return this.set(f,this.$M+r);if($===c)return this.set(c,this.$y+r);if($===a)return y(1);if($===o)return y(7);var M=(d={},d[s]=e,d[u]=n,d[i]=t,d)[$]||1,m=this.$d.getTime()+r*M;return O.w(m,this)},m.subtract=function(t,e){return this.add(-1*t,e)},m.format=function(t){var e=this,n=this.$locale();if(!this.isValid())return n.invalidDate||l;var r=t||"YYYY-MM-DDTHH:mm:ssZ",i=O.z(this),s=this.$H,u=this.$m,a=this.$M,o=n.weekdays,f=n.months,h=function(t,n,i,s){return t&&(t[n]||t(e,r))||i[n].slice(0,s)},c=function(t){return O.s(s%12||12,t,"0")},d=n.meridiem||function(t,e,n){var r=t<12?"AM":"PM";return n?r.toLowerCase():r},$={YY:String(this.$y).slice(-2),YYYY:this.$y,M:a+1,MM:O.s(a+1,2,"0"),MMM:h(n.monthsShort,a,f,3),MMMM:h(f,a),D:this.$D,DD:O.s(this.$D,2,"0"),d:String(this.$W),dd:h(n.weekdaysMin,this.$W,o,2),ddd:h(n.weekdaysShort,this.$W,o,3),dddd:o[this.$W],H:String(s),HH:O.s(s,2,"0"),h:c(1),hh:c(2),a:d(s,u,!0),A:d(s,u,!1),m:String(u),mm:O.s(u,2,"0"),s:String(this.$s),ss:O.s(this.$s,2,"0"),SSS:O.s(this.$ms,3,"0"),Z:i};return r.replace(y,(function(t,e){return e||$[t]||i.replace(":","")}))},m.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},m.diff=function(r,d,l){var $,y=O.p(d),M=w(r),m=(M.utcOffset()-this.utcOffset())*e,v=this-M,g=O.m(this,M);return g=($={},$[c]=g/12,$[f]=g,$[h]=g/3,$[o]=(v-m)/6048e5,$[a]=(v-m)/864e5,$[u]=v/n,$[s]=v/e,$[i]=v/t,$)[y]||v,l?g:O.a(g)},m.daysInMonth=function(){return this.endOf(f).$D},m.$locale=function(){return D[this.$L]},m.locale=function(t,e){if(!t)return this.$L;var n=this.clone(),r=S(t,e,!0);return r&&(n.$L=r),n},m.clone=function(){return O.w(this.$d,this)},m.toDate=function(){return new Date(this.valueOf())},m.toJSON=function(){return this.isValid()?this.toISOString():null},m.toISOString=function(){return this.$d.toISOString()},m.toString=function(){return this.$d.toUTCString()},M}(),T=_.prototype;return w.prototype=T,[["$ms",r],["$s",i],["$m",s],["$H",u],["$W",a],["$M",f],["$y",c],["$D",d]].forEach((function(t){T[t[1]]=function(e){return this.$g(e,t[0],t[1])}})),w.extend=function(t,e){return t.$i||(t(e,_,w),t.$i=!0),w},w.locale=S,w.isDayjs=p,w.unix=function(t){return w(1e3*t)},w.en=D[g],w.Ls=D,w.p={},w}));
</script>
    <style>
        .sortable th {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        .sortable th::after {
            content: "↕";
            position: absolute;
            right: 8px;
            color: #a0aec0;
        }
        .sortable th.asc::after {
            content: "↑";
            color: #4299e1;
        }
        .sortable th.desc::after {
            content: "↓";
            color: #4299e1;
        }
        .table-fixed {
            table-layout: fixed;
        }
        .address-col {
            width: 20%;
            word-break: break-all;
        }
        .date-col {
            width: 20%;
        }
        .bool-col {
            width: 10%;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">UBA Recipients Visualizer</h1>
        
        <!-- Stats Section -->
        <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-sm font-semibold text-gray-600">Total Recipients</h2>
                <p id="total-count" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-sm font-semibold text-gray-600">With Lockers</h2>
                <p id="locker-count" class="text-3xl font-bold text-green-600">0</p>
                <p id="locker-percent" class="text-sm text-gray-500">0%</p>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-sm font-semibold text-gray-600">Claimed</h2>
                <p id="claimed-count" class="text-3xl font-bold text-purple-600">0</p>
                <p id="claimed-percent" class="text-sm text-gray-500">0%</p>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h2 class="text-sm font-semibold text-gray-600">Last Updated</h2>
                <p id="last-updated" class="text-lg font-medium text-gray-800">-</p>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-lg font-semibold mb-3">Filters</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <input type="text" id="filter-address" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Search addresses...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Claimed Status</label>
                    <select id="filter-claimed" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All</option>
                        <option value="true">Claimed</option>
                        <option value="false">Not Claimed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Has Locker</label>
                    <select id="filter-locker" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All</option>
                        <option value="true">Has Locker</option>
                        <option value="false">No Locker</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Table -->
        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table id="recipients-table" class="min-w-full table-fixed divide-y divide-gray-200 sortable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="address-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="address">Address</th>
                            <th scope="col" class="date-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="topUpDate">Top-Up Date</th>
                            <th scope="col" class="bool-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="claimed">Claimed</th>
                            <th scope="col" class="address-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="lockerAddress">Locker Address</th>
                            <th scope="col" class="date-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="lockerCheckedDate">Locker Checked Date</th>
                            <th scope="col" class="date-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="lastChecked">Last Checked</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="table-body">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span id="showing-count">0</span> of <span id="total-rows">0</span> recipients
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let recipients = [];
        let filteredRecipients = [];
        let currentSort = { field: 'lastChecked', direction: 'desc' };

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return dayjs(dateString).format('YYYY-MM-DD HH:mm:ss');
        }

        // Format address for display
        function formatAddress(address) {
            if (!address) return 'N/A';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard: ' + text);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Load data
        async function loadData() {
            try {
                // parse data as json
                const recipientData = await fetch("/recipients?cache=3600000");
                recipients = JSON.parse(recipientData.data);
                console.log(recipients);

                // Update stats
                updateStats();
                
                // Apply initial sort and filter
                applyFiltersAndSort();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-red-500">
                            Error loading data: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Update stats display
        function updateStats() {
            const total = recipients.length;
            const withLocker = recipients.filter(r => r.lockerAddress).length;
            const claimed = recipients.filter(r => r.claimed).length;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('locker-count').textContent = withLocker;
            document.getElementById('claimed-count').textContent = claimed;
            
            const lockerPercent = total > 0 ? Math.round((withLocker / total) * 100) : 0;
            const claimedPercent = total > 0 ? Math.round((claimed / total) * 100) : 0;
            
            document.getElementById('locker-percent').textContent = `${lockerPercent}%`;
            document.getElementById('claimed-percent').textContent = `${claimedPercent}%`;
            
            // Find most recent update
            if (recipients.length > 0) {
                const lastCheckedDates = recipients
                    .map(r => r.lastChecked)
                    .filter(Boolean)
                    .sort((a, b) => new Date(b) - new Date(a));
                
                if (lastCheckedDates.length > 0) {
                    document.getElementById('last-updated').textContent = formatDate(lastCheckedDates[0]);
                }
            }
        }

        // Apply filters and sort
        function applyFiltersAndSort() {
            const addressFilter = document.getElementById('filter-address').value.toLowerCase();
            const claimedFilter = document.getElementById('filter-claimed').value;
            const lockerFilter = document.getElementById('filter-locker').value;
            
            // Apply filters
            filteredRecipients = recipients.filter(recipient => {
                // Address filter
                const addressMatch = recipient.address.toLowerCase().includes(addressFilter);
                
                // Claimed filter
                let claimedMatch = true;
                if (claimedFilter === 'true') claimedMatch = recipient.claimed === true;
                if (claimedFilter === 'false') claimedMatch = recipient.claimed !== true;
                
                // Locker filter
                let lockerMatch = true;
                if (lockerFilter === 'true') lockerMatch = !!recipient.lockerAddress;
                if (lockerFilter === 'false') lockerMatch = !recipient.lockerAddress;
                
                return addressMatch && claimedMatch && lockerMatch;
            });
            
            // Apply sort
            filteredRecipients.sort((a, b) => {
                const aValue = a[currentSort.field] || '';
                const bValue = b[currentSort.field] || '';
                
                // Special handling for boolean values
                if (typeof aValue === 'boolean' && typeof bValue === 'boolean') {
                    return currentSort.direction === 'asc' 
                        ? (aValue === bValue ? 0 : aValue ? -1 : 1)
                        : (aValue === bValue ? 0 : aValue ? 1 : -1);
                }
                
                // Sort for strings and dates
                if (currentSort.direction === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });
            
            // Update table
            renderTable();
        }

        // Render table with current data
        function renderTable() {
            const tableBody = document.getElementById('table-body');
            
            if (filteredRecipients.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                            No recipients found matching your filters
                        </td>
                    </tr>
                `;
                document.getElementById('showing-count').textContent = '0';
                document.getElementById('total-rows').textContent = recipients.length;
                return;
            }
            
            let tableHtml = '';
            
            filteredRecipients.forEach((recipient, index) => {
                tableHtml += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <span class="cursor-pointer hover:text-blue-600" 
                                    onclick="copyToClipboard('${recipient.address}')" 
                                    title="Click to copy full address">
                                    ${formatAddress(recipient.address)}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(recipient.topUpDate)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                recipient.claimed 
                                    ? 'bg-green-100 text-green-800' 
                                    : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${recipient.claimed ? 'Yes' : 'No'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${recipient.lockerAddress 
                                ? `<span class="cursor-pointer hover:text-blue-600" 
                                     onclick="copyToClipboard('${recipient.lockerAddress}')" 
                                     title="Click to copy full address">
                                     ${formatAddress(recipient.lockerAddress)}
                                   </span>` 
                                : 'N/A'
                            }
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(recipient.lockerCheckedDate)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(recipient.lastChecked)}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHtml;
            document.getElementById('showing-count').textContent = filteredRecipients.length;
            document.getElementById('total-rows').textContent = recipients.length;
        }

        // Set up sorting
        function setupSorting() {
            const tableHeaders = document.querySelectorAll('th[data-sort]');
            
            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const field = header.getAttribute('data-sort');
                    
                    // Update sort direction
                    if (currentSort.field === field) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.field = field;
                        currentSort.direction = 'asc';
                    }
                    
                    // Update header classes
                    tableHeaders.forEach(h => {
                        h.classList.remove('asc', 'desc');
                    });
                    
                    header.classList.add(currentSort.direction);
                    
                    // Apply sort
                    applyFiltersAndSort();
                });
            });
        }

        // Set up filter event listeners
        function setupFilters() {
            const addressFilter = document.getElementById('filter-address');
            const claimedFilter = document.getElementById('filter-claimed');
            const lockerFilter = document.getElementById('filter-locker');
            
            // Add event listeners
            addressFilter.addEventListener('input', applyFiltersAndSort);
            claimedFilter.addEventListener('change', applyFiltersAndSort);
            lockerFilter.addEventListener('change', applyFiltersAndSort);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupSorting();
            setupFilters();
            loadData();
        });
    </script>
</body>
</html>
